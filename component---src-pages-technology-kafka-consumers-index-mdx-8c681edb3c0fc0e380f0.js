(window.webpackJsonp=window.webpackJsonp||[]).push([[85,73,123],{"013z":function(e,t,a){"use strict";var s=a("q1tI"),o=a.n(s),n=a("NmYn"),r=a.n(n),i=a("Wbzz"),c=a("Xrax"),l=a("k4MR"),m=a("TSYQ"),b=a.n(m),p=a("QH2O"),d=a.n(p),u=a("qKvR"),f=function(e){var t,a=e.title,s=e.theme,o=e.tabs,n=void 0===o?[]:o;return Object(u.b)("div",{className:b()(d.a.pageHeader,(t={},t[d.a.withTabs]=n.length,t[d.a.darkMode]="dark"===s,t))},Object(u.b)("div",{className:"bx--grid"},Object(u.b)("div",{className:"bx--row"},Object(u.b)("div",{className:"bx--col-lg-12"},Object(u.b)("h1",{id:"page-title",className:d.a.text},a)))))},g=a("BAC9"),h=function(e){var t=e.relativePagePath,a=e.repository,s=Object(i.useStaticQuery)("1364590287").site.siteMetadata.repository,o=a||s,n=o.baseUrl,r=o.subDirectory,c=n+"/edit/"+o.branch+r+"/src/pages"+t;return n?Object(u.b)("div",{className:"bx--row "+g.row},Object(u.b)("div",{className:"bx--col"},Object(u.b)("a",{className:g.link,href:c},"Edit this page on GitHub"))):null},A=a("FCXl"),j=a("dI71"),O=a("I8xM"),w=function(e){function t(){return e.apply(this,arguments)||this}return Object(j.a)(t,e),t.prototype.render=function(){var e=this.props,t=e.title,a=e.tabs,s=e.slug,o=s.split("/").filter(Boolean).slice(-1)[0],n=a.map((function(e){var t,a=r()(e,{lower:!0,strict:!0}),n=a===o,c=new RegExp(o+"/?(#.*)?$"),l=s.replace(c,a);return Object(u.b)("li",{key:e,className:b()((t={},t[O.selectedItem]=n,t),O.listItem)},Object(u.b)(i.Link,{className:O.link,to:""+l},e))}));return Object(u.b)("div",{className:O.tabsContainer},Object(u.b)("div",{className:"bx--grid"},Object(u.b)("div",{className:"bx--row"},Object(u.b)("div",{className:"bx--col-lg-12 bx--col-no-gutter"},Object(u.b)("nav",{"aria-label":t},Object(u.b)("ul",{className:O.list},n))))))},t}(o.a.Component),k=a("MjG9"),y=a("CzIb"),v=a("Asxa"),N=a("OIbQ"),x=a.n(N),C=function(e){var t=e.date,a=new Date(t);return t?Object(u.b)(v.c,{className:x.a.row},Object(u.b)(v.a,null,Object(u.b)("div",{className:x.a.text},"Page last updated: ",a.toLocaleDateString("en-GB",{day:"2-digit",year:"numeric",month:"long"})))):null};t.a=function(e){var t=e.pageContext,a=e.children,s=e.location,o=e.Title,n=t.frontmatter,m=void 0===n?{}:n,b=t.relativePagePath,p=t.titleType,d=m.tabs,g=m.title,j=m.theme,O=m.description,v=m.keywords,N=m.date,x=Object(y.a)().interiorTheme,B=Object(i.useStaticQuery)("2456312558").site.pathPrefix,T=B?s.pathname.replace(B,""):s.pathname,K=d?T.split("/").filter(Boolean).slice(-1)[0]||r()(d[0],{lower:!0}):"",U=j||x;return Object(u.b)(l.a,{tabs:d,homepage:!1,theme:U,pageTitle:g,pageDescription:O,pageKeywords:v,titleType:p},Object(u.b)(f,{title:o?Object(u.b)(o,null):g,label:"label",tabs:d,theme:U}),d&&Object(u.b)(w,{title:g,slug:T,tabs:d,currentTab:K}),Object(u.b)(k.a,{padded:!0},a,Object(u.b)(h,{relativePagePath:b}),Object(u.b)(C,{date:N})),Object(u.b)(A.a,{pageContext:t,location:s,slug:T,tabs:d,currentTab:K}),Object(u.b)(c.a,null))}},BAC9:function(e,t,a){e.exports={bxTextTruncateEnd:"EditLink-module--bx--text-truncate--end--2pqje",bxTextTruncateFront:"EditLink-module--bx--text-truncate--front--3_lIE",link:"EditLink-module--link--1qzW3",row:"EditLink-module--row--1B9Gk"}},I8xM:function(e,t,a){e.exports={bxTextTruncateEnd:"PageTabs-module--bx--text-truncate--end--267NA",bxTextTruncateFront:"PageTabs-module--bx--text-truncate--front--3xEQF",tabsContainer:"PageTabs-module--tabs-container--8N4k0",list:"PageTabs-module--list--3eFQc",listItem:"PageTabs-module--list-item--nUmtD",link:"PageTabs-module--link--1mDJ1",selectedItem:"PageTabs-module--selected-item--YPVr3"}},OIbQ:function(e,t,a){e.exports={bxTextTruncateEnd:"last-modified-date-module--bx--text-truncate--end--123zi",bxTextTruncateFront:"last-modified-date-module--bx--text-truncate--front--3xeKz",text:"last-modified-date-module--text--24m-4",row:"last-modified-date-module--row--2BquN"}},QH2O:function(e,t,a){e.exports={bxTextTruncateEnd:"PageHeader-module--bx--text-truncate--end--mZWeX",bxTextTruncateFront:"PageHeader-module--bx--text-truncate--front--3zvrI",pageHeader:"PageHeader-module--page-header--3hIan",darkMode:"PageHeader-module--dark-mode--hBrwL",withTabs:"PageHeader-module--with-tabs--3nKxA",text:"PageHeader-module--text--o9LFq"}},nW5q:function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return i})),a.d(t,"default",(function(){return u}));var s=a("wx14"),o=a("zLVn"),n=(a("q1tI"),a("7ljp")),r=a("013z"),i=(a("qKvR"),{}),c=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(n.b)("div",t)}},l=c("InlineNotification"),m=c("AnchorLinks"),b=c("AnchorLink"),p={_frontmatter:i},d=r.a;function u(e){var t=e.components,a=Object(o.a)(e,["components"]);return Object(n.b)(d,Object(s.a)({},p,a,{components:t,mdxType:"MDXLayout"}),Object(n.b)(l,{kind:"warning",mdxType:"InlineNotification"},Object(n.b)("strong",null,"Updated 03/28/2022")),Object(n.b)(m,{mdxType:"AnchorLinks"},Object(n.b)(b,{mdxType:"AnchorLink"},"Understanding Kafka Consumers"),Object(n.b)(b,{mdxType:"AnchorLink"},"Consumer group"),Object(n.b)(b,{mdxType:"AnchorLink"},"Assess number of consumers needed"),Object(n.b)(b,{mdxType:"AnchorLink"},"Offset management")),Object(n.b)("h2",null,"Understanding Kafka Consumers"),Object(n.b)("p",null,"This chapter includes some technology summary and best practices about Kafka consumer. It may be useful for beginner or seasoned developers who\nwant a refresh after some time far away from Kafka…"),Object(n.b)("h2",null,"Consumer group"),Object(n.b)("p",null,"Consumers belong to ",Object(n.b)("strong",{parentName:"p"},"consumer groups"),". You specify the group name as part of the consumer connection parameters using the ",Object(n.b)("inlineCode",{parentName:"p"},"group.id")," configuration:"),Object(n.b)("pre",null,Object(n.b)("code",{parentName:"pre",className:"language-java"},"  properties.put(ConsumerConfig.GROUP_ID_CONFIG,  groupid);\n")),Object(n.b)("p",null,"Consumer groups are grouping consumers to cooperate to consume messages from one or more topics. Consumers can run in separate hosts and separate processes.\nThe figure below represents 2 consumer apps belonging to the same consumer group. Consumer 1 is getting data from 2 partitions, while consumer 2 is getting from one partition."),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1042px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"69.44444444444444%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZUlEQVQ4y2VT227TQBDNp/IN8AgSNyHBD/ACogUq4BkJkEDlDVGEKKVFXNI2bpzEjuNrHK/tXds9zMymTVMsHe/u8ezZszPjHujJFi1GU4NxYDBaYhoZBLEFz0/8BgOvgUNwpxZn6yF9C9OWpdDj19A3+PyjwM6+wpcDJePRiYIzKjFwFaHE977Bt79GxoNjjb1DLetdWv+k9R+nXgnW+hS56rAgJLlFPG8FZ/Mwa+FFzHV0o07imZuRs3nRQVWdFew6Els0UGUjY5g2iAh81VnSwAuNwKVbeDODOcUUahXLMXnRCN80HXradDiZ1DgcGXz9rbF/pGXu+lr4dM6bbH55zrxDPB/qh/YQnnOsooN6WndC3toscf2xwu1NhSv3F9jra3GZ5xoTv8KA8plmtXDsOMs0XK/EcMK8lsKdC04Cje1dg7c7Gq8/aWy8q3E8tqfXdYuIHAa0oarILQlOiC8ryivxvC4pXf6a4EyjVAZxUomLutISPJhoPHhZknsl7m88UfjlaBFPyNWYnLteJQ75+msO57lBGFNuYi0BfLJDgo/eVLj7TOHawwI3NxT6Q9ubbGAa1vBnnDvbq8VFQa5yNjcC/hDEjTR717ayoa4MGtMgTtm5wYvtGs/f19j6UOPVR1tITsm5YJxqeNMSflAhjCo50SXBJOWilFKYgBxxKvpDjXtbCneeKnF/ldxzc2t9ocqXnzizv+PlJ8psAcgwsuJUwPMwaZZXpj50xpX0UrhEnNl+Ox7V9Ges+Chb9WFCfJZbpLntQxFs21MqAjVnoteQZNzI//Ppkg8TvQauuiFz/wAP3R2+2tcurwAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"consumer group",title:"consumer group",src:"/refarch-eda/static/9b2e44a69c651fd2bcee2f35ca5e3e7b/e65ee/consumer-group.png",srcSet:["/refarch-eda/static/9b2e44a69c651fd2bcee2f35ca5e3e7b/7fc1e/consumer-group.png 288w","/refarch-eda/static/9b2e44a69c651fd2bcee2f35ca5e3e7b/a5df1/consumer-group.png 576w","/refarch-eda/static/9b2e44a69c651fd2bcee2f35ca5e3e7b/e65ee/consumer-group.png 1042w"],sizes:"(max-width: 1042px) 100vw, 1042px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"When a consumer is unique in a group, it will get data from all partitions. There is always at least one consumer per partition."),Object(n.b)("p",null,"One broker is responsible to be the consumer group coordinator which is responsible for assigning partitions to the consumers in the group.\nThe first consumer to join the group will be the group leader. It will get the list of consumers and it is responsible for assigning a subset\nof partitions to each consumer."),Object(n.b)("p",null,"Membership in a consumer group is maintained dynamically. Consumers send hearbeats to the group coordinator broker (see configuration like\n",Object(n.b)("a",{parentName:"p",href:"https://kafka.apache.org/documentation/#consumerconfigs_heartbeat.interval.ms"},"heartbeat.interval.ms"),") and ",Object(n.b)("inlineCode",{parentName:"p"},"session.timeout.ms"),".\nPartition assignement is done by different strategies from range, round robin, sticky and cooperative sticky (See ",Object(n.b)("a",{parentName:"p",href:"https://kafka.apache.org/documentation/#consumerconfigs_partition.assignment.strategy"},"partition assignement strategy"),"). "),Object(n.b)("p",null,"When a consumer fails, the partitions assigned to it will be reassigned to an other consumer in the same group. When a new consumer joins\nthe group, partitions will be moved from existing consumers to the new one. Group rebalancing is also used when new partitions are added to one\nof the subscribed topics. The group will automatically detect the new partitions through periodic metadata refreshes and assign them to members\nof the group. During a rebalance, depending of the strategy, consumers may not consume messages (Need Kafka 2.4+ to get cooperative balancing feature). "),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"51.388888888888886%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1UlEQVQoz21SaY+bMBTk//+i9uO2arXbaldJNhdJyAUEEhLAgdhc9nRMVKWRijQ8H+/NvMOOMQaABf9c3/d42j/OrQX8qMZ0JTHzJK3CbF1huasQJQ2c54D7p7WBrDT+96nKYORKvA1LvI1KDKYCo1kK18uxP9Rw/nWWdBalxllohKcWotC43jRKqft1KjokWYdv7ze8vEtCYWjJVhGm7hF+TMILnU6phYYXKHwsSnx6JcbEwC0wWlyxDmrkJIzObS/0/eNBOJimmC4ijOdx34qnDJNcYxV2WEcdwqTF9tBg5NXYxW1PZjO02f76lPj6s8SXHzdMKLj3M3ib7E5Y0OFa2tIM9sca47XEZCPh7hvUtUbOO+/YwehHjz0KDVd1Lzbb1fDCFnP6B0zCsc23qjdlcExbZthgzYDgwr5VQHzpUNSmhx1x09GvpLgw2Oa0PTQyxp+lgaPoqEha0R7ODeYc/zIgfPZnKZEwWHBYF1ZwLBhE6yYa85PG7MS9UMjzHOJa9KROwSnahlv4LHmyUSxXYb6VWNKmVL0Qye1O5jOj1z376Gv8Dg028RVbP8QujPv7p6G0Hd9Z/Rcsr308eltqxX3J80Dcs7Wlx4IDyxQOWdWL/wGQNPmRwKHO3AAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"consumer groups",title:"consumer groups",src:"/refarch-eda/static/75701f1ef05216ee0b2dab14e2541f68/3cbba/consumer-groups.png",srcSet:["/refarch-eda/static/75701f1ef05216ee0b2dab14e2541f68/7fc1e/consumer-groups.png 288w","/refarch-eda/static/75701f1ef05216ee0b2dab14e2541f68/a5df1/consumer-groups.png 576w","/refarch-eda/static/75701f1ef05216ee0b2dab14e2541f68/3cbba/consumer-groups.png 1152w","/refarch-eda/static/75701f1ef05216ee0b2dab14e2541f68/6e3b3/consumer-groups.png 1252w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"Implementing a Topic consumer is using the kafka ",Object(n.b)("a",{parentName:"p",href:"https://kafka.apache.org/24/javadoc/?org/apache/kafka/clients/consumer/KafkaConsumer.html"},"KafkaConsumer class"),"\nwhich the API documentation is a must read. It is interesting to note that:"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"To support the same semantic of a queue processing like other integration messaging systems, you need to have all the consumers assigned to a single consumer group,\nso that each record delivery would be balanced over the group like with a queue."),Object(n.b)("li",{parentName:"ul"},"To support pub/sub like other messaging systems, each consumer would have its own consumer group, and subscribes to all the records published\nto the topic."),Object(n.b)("li",{parentName:"ul"},"With ",Object(n.b)("inlineCode",{parentName:"li"},"client.rack")," setting a consumer can consume from a local replica, which will have better latency when using a stretched cluster or multiple availability zones.")),Object(n.b)("p",null,"For a single thread consumer, the implementation code follow the following pattern:"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"prepare the consumer properties"),Object(n.b)("li",{parentName:"ul"},"create an instance of KafkaConsumer to subscribe to at least one topic"),Object(n.b)("li",{parentName:"ul"},"loop on polling events: the consumer ensures its liveness with the broker via the poll API. It will get ",Object(n.b)("inlineCode",{parentName:"li"},"n records")," per poll."),Object(n.b)("li",{parentName:"ul"},"process the ConsumerRecords and commit the offset by code or by using the autocommit attribute of the consumer")),Object(n.b)("p",null,"As long as the consumer continues to call poll(), it will stay in the group and continues to receive messages from the partitions it was assigned to.\nWhen the consumer does not send heartbeats for a duration of ",Object(n.b)("inlineCode",{parentName:"p"},"session.timeout.ms"),", then it is considered unresponsive and its partitions will be reassigned."),Object(n.b)("p",null,"Examples of Java consumers can be found in ",Object(n.b)("a",{parentName:"p",href:"https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderEventAgent.java"},"the order management microservice project")," under the order-command-ms folder."),Object(n.b)("p",null,"We are proposing a deep dive study on this manual offset commit in ",Object(n.b)("a",{parentName:"p",href:"https://github.com/ibm-cloud-architecture/eda-quickstarts/blob/main/quarkus-consumer-kafka-api"},"this consumer code"),".\nExample of Javascript implementation is in ",Object(n.b)("a",{parentName:"p",href:"https://github.com/ibm-cloud-architecture/refarch-kc-ms/blob/master/voyages-ms/server/utils/kafka.js"},"this repository/folder")),Object(n.b)("p",null,"But the complexity comes from the offset management and multithreading needs. So the following important considerations need to be addressed while implementing a consumer."),Object(n.b)("h2",null,"Assess number of consumers needed"),Object(n.b)("p",null,"The KafkaConsumer is not thread safe so it is recommended to run in a unique thread. If really, needed you can implement a multi-threads solution,\nbut as each thread will open a TCP connection to the Kafka brokers, be sure to close the connection to avoid memory leak.\nThe alternate is to start n processes (JVM process) with a mono thread."),Object(n.b)("p",null,"If you need multiple consumers running in parallel to scale horizontally, you have to define multiple partitions while configuring the topic and use\nfine-grained control over offset persistence.\nThe consumer-per-partition pattern maximizes throughput. When consumers run in parallel and you use multiple threads per consumer you need to be sure\nthe total number of threads across all instances do not exceed the total number of partitions in the topic."),Object(n.b)("p",null,"Also, a consumer can subscribe to multiple topics. The brokers are doing rebalancing of the assignment of topic-partition to a consumer\nthat belong to a group. "),Object(n.b)("h2",null,"Offset management"),Object(n.b)("p",null,"Recall that offset is just a numeric identifier of a consumer position of the last record read within a partition. Consumers periodically need to\ncommit the offsets they have received, to present a recovery point in case of failure. To commit offset (via API or automatically) the consumer\nsends a message to kafka broker to the special topic named ",Object(n.b)("inlineCode",{parentName:"p"},"__consumer_offsets")," to keep the committed offset for each partition. "),Object(n.b)("p",null,"Consumers do a read commit for the last processed record: "),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"676px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"54.513888888888886%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB6klEQVQoz21SiXKbMBDl/7+rM+lMmrapazt2fBvMLRDCYJ2vKxEnaac7Ixae3r69iIxxOGQG24vGJiHvz8XgNTbYkd+Q9/iO7t+x5H4/YduAabS9ReQfnuDt60JCjA6DdHjeqoAtTxpFa2Ed8GunIIma1CRAYt7mBwU+OPQUtz5rRPzqKJNEJzjmR4NWDOiHEbvUoL8Kql6j7iS4EDiXDg0XyJlEUlFFvEVcOZRND96P2GdUYUeCm/iGvKpJ0CKvBRi/YptaCm6wTxWK5oaStTiVQFo0SMqRxClRw4LgOeMoWE/JHaJGWBzzqeVvKwlFr7695Umh6x1W1IYYbbhfnacx1N0U0woXZu9jaBVTyyPN6/deh9Z+bHQYrifNCHt+lXiYSyyOfvgaT+uJt6TvFwp+XIyEqTBnf5KKWsabFcwgLelUk8/Iv+wVjC/3zfwfcSbBnJZyoZaXexlw5z440f3jcFFoOwNxtbQUS+1aDDf7V4DHPc/jrTD4pBM4/kT3zDUHLjTggjnENB9fSdUaKH2Pol9jAG34jddYbGOFY6rBuo/EQVBpi+/zDA8/M8zWtNnkFoh+DNq49wqTXODLU4zHWYHVoaNqNSXXaP4VtNaiZgxFVYB33NeMz3YXvA4D8rJAxSpIOf6X8wcv50mdlkhLYgAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"of-1",title:"of-1",src:"/refarch-eda/static/6804c4c12cc260f154d7de73a61b4cf6/71afc/offsets.png",srcSet:["/refarch-eda/static/6804c4c12cc260f154d7de73a61b4cf6/7fc1e/offsets.png 288w","/refarch-eda/static/6804c4c12cc260f154d7de73a61b4cf6/a5df1/offsets.png 576w","/refarch-eda/static/6804c4c12cc260f154d7de73a61b4cf6/71afc/offsets.png 676w"],sizes:"(max-width: 676px) 100vw, 676px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"When a consumer starts, it receives a partition to consume, and it starts at its group’s committed offset or the latest or earliest offset\nas specified in the ",Object(n.b)("a",{parentName:"p",href:"https://kafka.apache.org/documentation/#auto.offset.reset"},"auto.offset.reset")," property."),Object(n.b)("p",null,"As shown in the figure below, in case of consumer failure, it is possible to get duplicates. When the last message processed by the consumer,\nbefore crashing, is younger than the last committed offset, the consumer will get this record again. This case may happen when using a time based commit strategy."),Object(n.b)("p",null,Object(n.b)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"32.63888888888889%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABMklEQVQoz32S6XKCQBCEff+HszQxJggKLAKCgnLGsMeXBXL9SDJVXTOz29MzeyyutUZpw2jGzL4sCvI8o6xuU64tBq2RGOsVyvqRebleOZcFheV/1i7yUqG/BLHi4IsYkRR0UYw+l9SBIN5sSdcbxHLF2fGQWY542HL2Y/ru9VtwDKQy00LVap7DNw4ncCJJGHbsdjc8r2Z/aBFBQ+C3uG6DY9d9G++8Bi8a6O8fgkEiEacZaSFZvlzZ7GucsCHMep78hsd9xcq9Tbl7bCfO2q14CSscUbN8vlG36nvC+ciGpjccUoVvEZwUIlNTozCVBMnAMZNEFt5xmHjRBURu8GJJd9ezIP/YfC3mRz43ltZdqo7HnY/jHynqfnq4sWCa8C+Mxb/low1vd9IkoRp/wo+9d5dhGMV4rVcoAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"kafka commit offset",title:"kafka commit offset",src:"/refarch-eda/static/9eb956af28a78c78a7f2fea0327dc947/3cbba/kafka-commit-offset.png",srcSet:["/refarch-eda/static/9eb956af28a78c78a7f2fea0327dc947/7fc1e/kafka-commit-offset.png 288w","/refarch-eda/static/9eb956af28a78c78a7f2fea0327dc947/a5df1/kafka-commit-offset.png 576w","/refarch-eda/static/9eb956af28a78c78a7f2fea0327dc947/3cbba/kafka-commit-offset.png 1152w","/refarch-eda/static/9eb956af28a78c78a7f2fea0327dc947/bed59/kafka-commit-offset.png 1232w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),"\n",Object(n.b)("em",{parentName:"p"},"Source: Kafka definitive guide book from Todd Palino, Gwen Shapira")),Object(n.b)("p",null,"In the opposite, if the last committed offset is after the last processed messages and there were multiple messages returned in the poll,\nthen those messages may be lost (in term of consumer processing not list in kafka). This will happen with autocommit set up at the time\nof the read operation, and the last offset of the poll is the committed offset. See the ",Object(n.b)("a",{parentName:"p",href:"https://kafka.apache.org/documentation/#consumerconfigs_enable.auto.commit"},"enable.auto.commit")," property."),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"32.29166666666667%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVQY022R2W7CQAxF8/8f1sfSskM2CIECAbLM0mab0wkpFS1YOrqWx7Y8tmOM4R64B07JgXUcc7RalZ/UdUlVfVFbmh+/i9/yHf5Za+OFtiiDsHrOSraXBhklpGOf8GVA5G2Jdhc2lvXmhB/uEaruGxaqtUUNmWjJZUsqGsaBYhrqX50FkmWQ48cKd62ZLAtGnmTiS9xIM18pFitNVRuctGj5SBoOdoqjJbHNhzZ55CvePXX1h664FrmRZBYqBgvB6zznbVEwDQRjT9jmirIyj19uWsgkdlrDWUCcwj7v1LBLW7aWQ2auK+lyCtmr1P0NnMej3Kz3u8WHgUsQBmgl/rw9s2/uicvXFFx9qgAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"kafka commit offset 2",title:"kafka commit offset 2",src:"/refarch-eda/static/fff6bc74bb07c8738efbc39cdc78c2c2/3cbba/kafka-commit-offset-2.png",srcSet:["/refarch-eda/static/fff6bc74bb07c8738efbc39cdc78c2c2/7fc1e/kafka-commit-offset-2.png 288w","/refarch-eda/static/fff6bc74bb07c8738efbc39cdc78c2c2/a5df1/kafka-commit-offset-2.png 576w","/refarch-eda/static/fff6bc74bb07c8738efbc39cdc78c2c2/3cbba/kafka-commit-offset-2.png 1152w","/refarch-eda/static/fff6bc74bb07c8738efbc39cdc78c2c2/b5a46/kafka-commit-offset-2.png 1178w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"Limiting to poll one message at the time, will help to avoid this problem, but will impact throughput."),Object(n.b)("p",null,"It is possible to commit by calling API so developer can control when to commit the read. For manual commit, we can use one of the two approaches:"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"offsets—synchronous commit: send the offset number for the records read using ",Object(n.b)("inlineCode",{parentName:"li"},"consumer.commitSync(Collections.singletonMap(partition, new OffsetAndMetadata(lastOffset + 1)))")," method "),Object(n.b)("li",{parentName:"ul"},"asynchronous")),Object(n.b)("p",null,"As soon as you are coding manual commit, it is strongly recommended to implement the ConsumerRebalanceListener interface to be able to do state\nmodifications when the topic is rebalanced."),Object(n.b)("p",null,"If a consumer fails after processing a message but before committing its offset, the committed offset information will not reflect the processing of the message. "),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"48.26388888888889%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB50lEQVQoz22Sa4+aQBiF/f9/qF+aJv1iskmru+u1ugqKIBdFRO7MzNN3tK1p00lOYAY477kw6JXBrstN4yc9wUkg15XT8bHrcQ891ytkmUEpSC+Kt3XL7POS4ZeI4bji5XvEZJnixx2D9KroeoNzbJhuSyabkrVX8r7OWTiF3Ff3gXVjSFNwdoqvo47RpwWj4ZH5Nmc8XvI29TgmQsivdS0M/kmLQk2SadlrLrniVmry/KGwbSFMNOOZDHZ6Jh8NrgxMTh27Q80hbBnYj6ztnWzmbsXMKdkeWm43KAruZEVhY3lEY92EQhDGjZC3gk6UtXcy63bQdo8XT5kS0g5XEEtOWkMlbq2q32T2TGtD1fwLfYd99sdyXj6snq+a6KzYSFb7oyIIxfrlQWRXUcvgoJIsa8aTmtdpy8bt2QctcSoKzyIzLw3boGbhFlKMYHOTsG/MJHAvquk6cXA2lBLBxlG8zit+OBUrt8bdZ6zWAfNliB+WT4Xn3LCPNF4sCi+2FHXPJJdyylIIT0aAlKB4eSuZriveVw2LVcK30UrU+vgyfGCt2hy8qGV9qFjsKjzJ0aqxRFn2dylNp+8FHOOWIGqERAqSP8MLe7JcM6glTNtcIM1tA0vacJSfu65tIU8iYywM/1/P85+VCPlM3a4q7wAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"of-2",title:"of-2",src:"/refarch-eda/static/8c29f64fd1f8fe592175dddda475a51d/3cbba/offsets-2.png",srcSet:["/refarch-eda/static/8c29f64fd1f8fe592175dddda475a51d/7fc1e/offsets-2.png 288w","/refarch-eda/static/8c29f64fd1f8fe592175dddda475a51d/a5df1/offsets-2.png 576w","/refarch-eda/static/8c29f64fd1f8fe592175dddda475a51d/3cbba/offsets-2.png 1152w","/refarch-eda/static/8c29f64fd1f8fe592175dddda475a51d/132e7/offsets-2.png 1404w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"This means that the message will be processed again by the next consumer in that group to be assigned the partition."),Object(n.b)("p",null,"Assess if it is acceptable to loose messages from topic.  If so, when a consumer restarts it will start consuming the topic from the latest\ncommitted offset within the partition allocated to itself."),Object(n.b)("p",null,"As storing a message to an external system and storing the offsets are two separate operations, and in case of failure between them,\nit is possible to have stale offsets, which will introduce duplicate messages when consumers restart to process from last known committed offset.\nIn this case, consumer’s idempotence is needed to support updating the same row in the table, or use the event timestamp as update timestamp in\nthe database record or use other clever solution."),Object(n.b)("p",null,"As presented in the producer coding practice, using transaction to support “exactly-once”, also means the consumers should read committed data only.\nThis can be achieved by setting the ",Object(n.b)("inlineCode",{parentName:"p"},"isolation.level=read_committed")," in the consumer’s configuration. The last offset will be the first message\nin the partition belonging to an open not yet committed transaction. This offset is known as the ‘Last Stable Offset’(LSO)."),Object(n.b)("p",null,"Finally in the case where consumers are set to auto commit, it means the offset if committed at the poll() level and if the service\ncrashed while processing of this record as: "),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"706px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"49.30555555555556%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB50lEQVQoz22S2ZKbMBRE+f9PyM+kkhdPUknF4/E2ZrENxng3ZpGQBOq0YJY8RFW3hCjR9Ll9PbwtZYBSALUEitricLJI9sNeloDWtr93e7RYJxL+qsRk3uBlqXnWiDMD0XTwHlXHB4v0rDAJaiy3AtOgwiJirUvs+V5KJ8oqgEVg8H30wNOXr/g2KvDj1xqjpxmeZyny0sDTxqLtLK78c5hqbDL+7aCQXRT3BvfCoGnQC0oSBBuN31OBuV9jFkiE6zNeVyndZsgLDU/pQfBWtNhQKD5qnO5tjyeJXxG3KOw/yAZhLLHeNYiIvk0Vdgdi7xQqQeSCyJLI2UVjGoke2U9ML6aUpTsnNIhZa1nsJ/vtTHR2MOMoTTvc8T5C0XRDkZLVSoW6anG6AvnD0iHQdcMHrgX7E91tFeYrjYWvkGSK7xQaGvDuRJV8iFLZh7IIC5zGr3hePDBelkh5saWje277PdxqLMMaK9K42iQCaSaYtOB0ENlZdhiubxtGHx8MyuSI80X2bSjoVCngfLY4HsE0NX5OBF58yVAEx2qoOBUonaALpeuA481QUPXBHK4dLHOpaiLnbENlP5CvuUEUuzAkNrvPipLmcw5d/wKm9mdVY8xx8GMNwRFxgbwLvYfijn0g/ym3/gK4xvrxUZirNwAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"of-3",title:"of-3",src:"/refarch-eda/static/4686853f10161b026f380c01f3e68127/46db9/offsets-3.png",srcSet:["/refarch-eda/static/4686853f10161b026f380c01f3e68127/7fc1e/offsets-3.png 288w","/refarch-eda/static/4686853f10161b026f380c01f3e68127/a5df1/offsets-3.png 576w","/refarch-eda/static/4686853f10161b026f380c01f3e68127/46db9/offsets-3.png 706w"],sizes:"(max-width: 706px) 100vw, 706px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"then the record (partition 0 - offset 4) will never be processed."),Object(n.b)("h2",null,"Producer transaction"),Object(n.b)("p",null,"When consuming from a Kafka topic and producing to another topic, like in Kafka Streams programming approach, we can use the producer’s transaction\nfeature to send the committed offset message and the new records in the second topic in the same transaction.  This can be seen as a\n",Object(n.b)("inlineCode",{parentName:"p"},"consume-transform-produce")," loop pattern so that every input event is processed exactly once. "),Object(n.b)("p",null,"An example of such pattern in done in the ",Object(n.b)("a",{parentName:"p",href:"https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/tree/master/order-command-ms"},"order management microservice - command part"),"."),Object(n.b)("h2",null,"Consumer lag"),Object(n.b)("p",null,"The consumer lag for a partition is the difference between the offset of the most recently published message and the consumer’s committed offset."),Object(n.b)("p",null,"If the lag starts to grow, it means the consumer is not able to keep up with the producer’s pace."),Object(n.b)("p",null,"The risk, is that slow consumer may fall behind, and when partition management may remove old log segments, leading the consumer to jump\nforward to continnue on the next log segment. Consumer may have lost messages."),Object(n.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"682px"}},"\n      ",Object(n.b)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"47.91666666666667%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1UlEQVQoz21Sa5OiMBD0//+z2w+3q6Csj/OBIAsRBSGBQJK+BrS2rm6naqoImfRMd88MDGuBrgeqGshvwL1wyHMgE0DKLArg8XBQyg3lEPceu1MLL9DwPjWCncYh0sRwmMnGYXtu4e8lgqPCL69ClGqoxuL36ob5+oYwaWHYsCRoUQLhRWPH2tWGuVWIYoV9qNC0FjNjHGLRY8+iMO2wIbi4dygrg8+jxCaUyMseUzi0LeBzqre5xGLT4D1QOMWsO8gJcCwjk57jSu1Qd0Ai7jhGCU4XgZKT9naosZRmonwl5dOlnTJucU40jvGTsnMO/4eDNYYAZvz+5+bH+u8YJ9RaU/QH6rpGVVVoeX7FoF0UUccwplHX8Z9UFuJmkF4NvphZbnArzchgZkgnpZXL5QpB8ImF50MIgZ7DeWuKvlOIvxQSGlMUU6NLpvGHprx7Ch++wmbXYMtzo6lhrThBnGI+97AK1lgslhBZhko6vPk5Rc+RXCegR0Wn6XKw1fhYsdm+gc+GSfZ0WT9NsVxEQ24l0fOyhuosJM15EHRI3bmnlm7c2SN3bsl1CQg4MDicFdZ7RansZMpL51pKLnU5PrXuG+S1CS9DBjcl3VfPrKnpcB7u/wJs7/4ZNlzRGQAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",Object(n.b)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"offsets 4",title:"offsets 4",src:"/refarch-eda/static/c3cca3accc73283d2e165bbb29377111/8bbfc/offsets-4.png",srcSet:["/refarch-eda/static/c3cca3accc73283d2e165bbb29377111/7fc1e/offsets-4.png 288w","/refarch-eda/static/c3cca3accc73283d2e165bbb29377111/a5df1/offsets-4.png 576w","/refarch-eda/static/c3cca3accc73283d2e165bbb29377111/8bbfc/offsets-4.png 682w"],sizes:"(max-width: 682px) 100vw, 682px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"}),"\n    "),Object(n.b)("p",null,"You can use the kafka-consumer-groups tool to see and manage the consumer lag."),Object(n.b)("h2",null,"Kafka useful Consumer APIs"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/consumer/KafkaConsumer.html"},"KafkaConsumer")," a topic consumer which support:",Object(n.b)("ul",{parentName:"li"},Object(n.b)("li",{parentName:"ul"},"transparently handles brokers failure"),Object(n.b)("li",{parentName:"ul"},"transparently adapt to partition migration within the cluster"),Object(n.b)("li",{parentName:"ul"},"support grouping for load balancing among consumers"),Object(n.b)("li",{parentName:"ul"},"maintains TCP connections to the necessary brokers to fetch data"),Object(n.b)("li",{parentName:"ul"},"subscribe to multiple topics and being part of consumer groups"),Object(n.b)("li",{parentName:"ul"},"each partition is assigned to exactly one consumer in the group"),Object(n.b)("li",{parentName:"ul"},"if a process fails, the partitions assigned to it will be reassigned to other consumers in the same group"))),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/consumer/ConsumerRecords.html"},"ConsumerRecords")," holds the list ConsumerRecord per partition for a particular topic."),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://kafka.apache.org/11/javadoc/org/apache/kafka/clients/consumer/ConsumerRecord.html"},"ConsumerRecord")," A key/value pair to be received from Kafka. This also consists of a topic name and a partition number from which the record is being received, an offset that points to the record in a Kafka partition, and a timestamp")),Object(n.b)("h3",null,"Repositories with consumer code"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"Within the Reefer ontainer shipment solution we have a order events consumer: ",Object(n.b)("a",{parentName:"li",href:"https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderEventAgent.java"},"order event agent")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://github.com/ibm-cloud-architecture/refarch-eda-store-inventory"},"Quarkus app with Kafka streams")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://github.com/ibm-cloud-architecture/refarch-kc-ms/blob/master/voyages-ms/server/utils/kafka.js"},"Nodejs kafka consumers and producers")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://github.com/ibm-cloud-architecture/refarch-kc/tree/master/itg-tests/kafka"},"A lot of python consumer codes in the integration tests, with or without Avro schema"))),Object(n.b)("h2",null,"References"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://ibm.github.io/event-streams/about/consuming-messages/"},"IBM Event Streams - Consuming messages")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",{parentName:"li",href:"https://kafka.apache.org/10/javadoc/?org/apache/kafka/clients/consumer/KafkaConsumer.html"},"KafkaConsumer class"))))}u.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-technology-kafka-consumers-index-mdx-8c681edb3c0fc0e380f0.js.map